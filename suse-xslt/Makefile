# Makefile for suse-xsl-stylesheets
#
# Copyright (C) 2011,2012 Frank Sundermeyer <fsundermeyer@opensuse.org>
#
# Author:
# Frank Sundermeyer <fsundermeyer@opensuse.org>
#

# IMPORTANT:
# Correct VERSION needs to be provided on the command line,
# for make all and make install !!!!
# this is just a fallback!!
#

VERSION    ?= 5.0

PACKAGE    := suse-xsl-stylesheets
DTDNAME    := novdoc
DTDVERSION := 1.0
DBSTYLES   := /usr/share/xml/docbook/stylesheet/nwalsh/current

NOVDOC_CATALOG := for-catalog-$(DTDNAME)-$(DTDVERSION).xml
NOVDOC_SCHEMA  := /usr/share/xml/novdoc/schema/dtd/$(DTDVERSION)

DIRECTORIES := catalogs

# html stylesheets are autogenerated from the xhtml stylesheets
# so we only need to maintain them in one place
#
XHTML2HTML    := common/xhtml2html.xsl
HTMLSTYLESHEETS=$(subst /xhtml/,/html/,$(wildcard suse-xslt/xhtml/*.xsl))



#-------
# Directories for installation
PREFIX    ?= /usr/share
STYLE_DIR := $(DESTDIR)$(PREFIX)/xml/docbook/stylesheet/suse
DOC_DIR   := $(DESTDIR)$(PREFIX)/doc/packages/suse-xsl-stylesheets

all: schema/novdocx.rnc schema/novdocx.rng
all: catalogs/$(NOVDOC_CATALOG)
all: catalogs/CATALOG.$(DTDNAME)-$(DTDVERSION)
all: xhtml2html
	@echo "Ready to install..."

install: create-install-dirs
	install -m644 schema/novdocx.{rnc,rng} \
	  $(DESTDIR)$(PREFIX)/xml/$(DTDNAME)/schema/rng/$(DTDVERSION)
	install -m644 schema/{*.dtd,*.ent,catalog.xml,CATALOG} \
	  $(DESTDIR)$(PREFIX)/xml/$(DTDNAME)/schema/dtd/$(DTDVERSION)
	install -m644 catalogs/CATALOG.$(DTDNAME)-$(DTDVERSION) \
	  $(DESTDIR)/var/lib/sgml && \
	  ln -s /var/lib/sgml/CATALOG.$(DTDNAME)-$(DTDVERSION) \
	    $(DESTDIR)$(PREFIX)/sgml/
	install -m644 COPYING* $(DOC_DIR)
	tar cp --exclude-from=Makefile suse-xslt/* | (cd  $(STYLE_DIR); tar xpv)
	find $(STYLEDIR) -type d -exec chmod 755 {} \;
	find $(DOC_DIR) -type f -exec chmod 644 {} \;

create-install-dirs:
	mkdir -p $(STYLEDIR)
	mkdir -p $(DESTDIR)$(PREFIX)/xml/$(DTDNAME)/schema/{dtd,rng}/$(DTDVERSION)
	mkdir -p $(DESTDIR)/var/lib/sgml
	mkdir -p $(DESTDIR)$(PREFIX)/sgml
	mkdir -p $(DESTDIR)/etc/xml


.PHONY: clean
clean:
	rm -rf catalogs/ schema/novdocx.rnc schema/novdocx.rng suse-xslt/html/

# auto-generate the html stylesheets
#
.PHONY: xhtml2html
xhtml2html: $(HTMLSTYLESHEETS)


#-----------------------------
# Auto-generate HTML stylesheets from XHTML:
suse-xslt/html/%.xsl: suse-xslt/xhtml/%.xsl
	xsltproc --output $@  ${XHTML2HTML} $<

#-----------------------------
# Generate SGML catalog for novdoc
#
catalogs/CATALOG.$(DTDNAME)-$(DTDVERSION): $(DIRECTORIES)
catalogs/CATALOG.$(DTDNAME)-$(DTDVERSION):
	echo \
	  "CATALOG \"$(NOVDOC_SCHEMA)/CATALOG\"" \
	  > $@

#-----------------------------
# Generate RELAX NG schemes for novdoc
#

schema/novdocx.rnc: schema/novdocx.dtd.tmp
	trang -I dtd $< $@

schema/novdocx.rng: schema/novdocx.dtd.tmp
	trang -I dtd $< $@

# To avoid unknown host errors with trang, we have to switch off the external
# entities from DocBook by creating a temporary file novdocx.dtd.tmp.
# As the entities are not used in RELAX NG anyway, this is uncritical.
#
.INTERMEDIATE: schema/novdocx.dtd.tmp
schema/novdocx.dtd.tmp: $(DIRECTORIES)
	sed 's:\(%[ \t]*ISO[^\.]*\.module[ \t]*\)"INCLUDE":\1"IGNORE":g' \
	  < schema/novdocx.dtd > $@

#-----------------------------
# Generate NOVDOC catalog
#

# since xmlcatalog cannot create groups (<group>) we need to use sed
# to fix this; while we are at it, we also remove the DOCTYPE line since 
# it may cause problems with some XML parsers (hen/egg probem)
#
catalogs/$(NOVDOC_CATALOG): $(DIRECTORIES)
catalogs/$(NOVDOC_CATALOG):
	xmlcatalog --noout --create $@
	xmlcatalog --noout --add "delegatePublic" "-//Novell//DTD NovDoc XML" \
	  "file://$(NOVDOC_SCHEMA)/catalog.xml" $@
	xmlcatalog --noout --add "delegateSystem" "novdocx.dtd" \
	  "file://$(NOVDOC_SCHEMA)/catalog.xml" $@
	sed -i '/^<!DOCTYPE .*>$$/d' $@
	sed -i '/<catalog/a\ <group id="$(DTDNAME)-$(DTDVERSION)">' $@
	sed -i '/<\/catalog/i\ </group>' $@

# create needed directories
#
$(DIRECTORIES):
	mkdir -p $@
