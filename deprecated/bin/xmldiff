#! /usr/bin/env zsh

## author: Joerg Arndt <arndt (AT) jjj.de>
# $Id: xmldiff 1669 2005-08-17 13:50:48Z bg $

#set -vx

function usage
{
    echo "Usage:"
    echo 'jjcvsdiff [-f from_revision] [-t to_revision] [-d output_directory] [-p] [-n] FILE';
    echo ' where FILE is a filename, e.g. xml/common/foo.xml';
    echo 'Options:';
    echo '   -f: revision number';
    echo '   -t: revision number; if omitted, HEAD will be used';
    echo '   -d: directory to use for postscript output';
    echo '   -n: suppress display on screen';
    echo 'Some environment variables are recognized:';
    echo ' - setting JJCVSDIFF_NO_STATS inhibits word statistics';
    echo ' - setting JJCVSDIFF_LINE_DIFF toggle line based diffs';
    echo '   (default is word diffs)'
    echo ' - setting JJCVSDIFF_CREATE_PS will create a postscript file';
    echo ' - setting JJCVSDIFF_KEEPFILES inhibits deletion of temporary files';
    echo ' - setting JJCVSDIFF_MGDIFF will give an diff by the mgdiff program'
    echo 'Examples, one-liners:' ;
    echo '  jjcvsdiff xml/common/foo.xml';
    echo '  JJCVSDIFF_CREATE_PS=yes jjcvsdiff xml/common/foo.xml';
    echo '  JJCVSDIFF_CREATE_PS=yes JJCVSDIFF_LINE_DIFF=yes jjcvsdiff xml/common/foo.xml';
    echo 'Example, permanent settings:' ;
    echo '  export JJCVSDIFF_NO_STATS=bla';
    echo '  export JJCVSDIFF_CREATE_PS=jawoll';
    echo '  jjcvsdiff xml/common/foo.xml';
    echo 'Example, for the change dir addicts:' ;
    echo '  cd xml/common';
    echo '  jjcvsdiff foo.xml';
    echo '  jjcvsdiff foo.xml';
    echo 'NOTE (convenience soft link): ';
    echo '  ln -sv  /ZAMZINK/suselx/common/tools/jjcvsdiff ~/bin';
    echo '          ^^^^^^^';
    echo '          |||||||';
    echo '        mutatis mutandis';
}

function cleanup_and_exit
{
    test -n "${JJCVSDIFF_KEEPFILES}" || rm -f $X1 $X2
    exit 0
}


test -n "${DEBUG}" && set -vx

type -p wdiff >/dev/null || { echo 'Please install wdiff!'; exit 1; }


if test "$1" = "" || test "$1" = "-h" || test  "$1" = "--help" ; then
    usage;
    exit 0;
fi

# adding revision options (bg)
# R2 will either be set manually, or should be HEAD.
R2="HEAD"
PDISPLAY="yes"
while test -n "$2"; do  ## FIXME: can malfunction in several ways, use getopt
    case $1 in
        -f=*|--from=*)
            R1="${1#*=}"
            shift
            ;;
        -f|--from)
            shift
            R1="$1"
            shift
            ;;
        -t=*|--to=*)
            R2="${1#*=}"
            shift
            ;;
        -t|--to)
            shift
            R2=$1
            shift
            ;;
        -p|--generate-ps)
            JJCVSDIFF_CREATE_PS="yes"
            shift
            ;;
        -n|--no-display)
            PDISPLAY=""
            shift
            ;;
#        -d=*|--output-directory=*)
#            R1="${1#*=}"
#            shift
#            ;;
        -d|--output-directory)
            shift
            DIFF_DIR=$1
            shift
            ;;
    esac
done

test -n "$1" ||  { echo 'Need a file name! (exiting)'; exit 1; }
F=$1
test -f $F  ||   { echo "$F"' is not a file. (exiting)'; exit 1; }


# R2 should be HEAD if R1 given, and R2 omitted
echo -n "R1: "
echo $R1
echo -n "R2: "
echo $R2


if [ -z "$R1" ]; then ## interactive
    cvs log  $F
    RR=$(cvs log $F | grep -E '^revision' | cut -d' ' -f 2)

    echo 'From revision (left):'
    select R1 in $(echo $RR); do
        X1=$F--$R1
        X1=$(basename $X1)
        echo "$X1";
        cvs up -r $R1 -p $F > $X1
        recode utf-8..iso8859-1 $X1
        break;
    done

    echo 'To revision (right):'
    select R2 in $(echo $RR); do
        X2=$F--$R2
        X2=$(basename $X2)
        echo "$X2";
        cvs up -r $R2 -p $F > $X2
        recode utf-8..iso8859-1 $X2
        break;
    done
else
    # use command line settings
    X1=$F--$R1
    X1=$(basename $X1)
    echo "$X1";
    cvs up -r $R1 -p $F > $X1 || cleanup_and_exit
    recode utf-8..iso8859-1 $X1
    X2=$F--$R2
    X2=$(basename $X2)
    echo "$X2";
    cvs up -r $R2 -p $F > $X2 || cleanup_and_exit
    recode utf-8..iso8859-1 $X2
fi


## start statistics
if [ -n "JJ_CVSDIFF_NO_STATS" ]; then
## to inhibit this part say:
## export JJ_CVSDIFF_NO_STATS=nope
    DF=tmp-diff.txt
    wdiff  --no-deleted --no-common $X1 $X2 > $DF
    recode iso8859-1..utf-8 $DF

    FOO=$(grep -Ev '(====*)|(^$)'  $DF | wc -l -c)

    echo >> $DF
    echo $X1 $X2 >> $DF
    echo " words/chars:  "$FOO >> $DF

    QQ=$(basename $F .xml)--diff.txt
    mv $DF $QQ
    cat $QQ
    ls -lF $QQ
fi
## end statistics


PSNAME=$(basename $F)--diff-$R1-$R2.ps

if test -n "${JJCVSDIFF_MGDIFF}"; then
    mgdiff -args "-dbwB"  $X1 $X2
else
    if test -n "${JJCVSDIFF_LINE_DIFF}"; then
        PDIFF_OPT='-l'
    else
        PDIFF_OPT='-w' # this is the default
    fi
        if test -n "$PDISPLAY"; then
            LC_CTYPE=en_US pdiff ${PDIFF_OPT} $X1 $X2 -- -Pdisplay --line-numbers=1
        fi
        if test -n "${JJCVSDIFF_CREATE_PS}"; then
            LC_CTYPE=en_US pdiff ${PDIFF_OPT} $X1 $X2 -- \
                                 -o ${DIFF_DIR}/${PSNAME} --line-numbers=1
        fi
        if test -n "$PDISPLAY"; then
            ls -l ${PSNAME}
        fi
fi

cleanup_and_exit;

exit 0;
###################################
