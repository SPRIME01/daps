#
# spec file for package susedoc (Version @RELEASE@)
#
# Copyright (c) 2006 SUSE LINUX Products GmbH, Nuernberg, Germany.
# This file and all modifications and additions to the pristine
# package are under the same license as the package itself.
#
# Please submit bugfixes or comments via http://bugs.opensuse.org/
#
#
# norootforbuild
%define dtdversion 1.0
%define packageversion 4.2
%define dtdname novdoc
%define docbuilddir /usr/share/susedoc

Name:           susedoc
%if 0%{?opensuse_bs}
Requires:       libxml2 libxslt inkscape transfig ImageMagick java xml-commons-resolver docbook-xsl-stylesheets svg-dtd freefont xalan-j2 fop >= svn482585
%else
Requires:       libxml2 libxslt inkscape transfig ImageMagick java xml-commons-resolver docbook-xsl-stylesheets svg-dtd freefont xalan-j2 agfa-fonts fop >= svn482585
%endif
%if %suse_version >= 1000
BuildRequires:  sgml-skel
%else
#neededforbuild libxml2 sgml-skel
%endif

License:        GPL
Group:          Productivity/Publishing/XML
Autoreqprov:    on
Version:        %{packageversion}_@RELEASE@
Release:        1
Summary:        XML Build Mechanics for Novell, SUSE, and openSUSE Documentation
# Needs to be fixed to openSUSE build server:
URL:            http://www.opensuse.org/Documentation_Team
Source0:        @SOURCE0@
BuildRoot:      %{_tmppath}/%{name}-%{version}-build
BuildArch:	    noarch
%define regcat /usr/bin/sgml-register-catalog
PreReq:         %{regcat} /usr/bin/xmlcatalog
Obsoletes:      novdoc-schema
Provides:       novdoc-schema

%description
This RPM consists of a set of stylesheets, scripts and makefiles that
are used to create HTML, PDF and Wiki documents from Novdoc/DocBook XML.

See also 
* http://developer.novell.com/wiki/index.php/Lessons_for_Lizards
* http://en.opensuse.org/Documentation_Team

Authors:
--------
    Karl Eichwalder   <ke AT suse DOT de>
    Berthold Gunreben <bg AT suse DOT de>
    Thomas Schraitle  <thomas DOT schraitle AT suse DOT de>
    Curtis Graham

%define INSTALL install -m755 -s
%define INSTALL_DIR install -d -m755
%define INSTALL_DATA install -m644
%define INSTALL_SCRIPT install -m755 -o root -g root
%define sgml_dir %{_datadir}/sgml
%define sgml_var_dir /var/lib/sgml
%define sgml_mod_dir %{sgml_dir}/novdoc
%define sgml_mod_dtd_dir %{sgml_mod_dir}/dtd
%define sgml_mod_custom_dir %{sgml_mod_dir}/custom
%define sgml_mod_style_dir %{sgml_mod_dir}/stylesheet
%define xml_dir %{_datadir}/xml
%define xml_mod_dir %{xml_dir}/novdoc/
%define xml_mod_dtd_dir %{xml_mod_dir}/schema/dtd/%{dtdversion}
%define xml_mod_custom_dir %{xml_mod_dir}/custom
%define xml_mod_style_dir %{xml_mod_dir}/stylesheet
%define sgml_config_dir /var/lib/sgml
%define sgml_sysconf_dir %{_sysconfdir}/sgml
%define xml_config_dir /var/lib/xml
%define xml_sysconf_dir %{_sysconfdir}/xml

#----------------------
%build
%define FOR_ROOT_CAT for-catalog-%{dtdname}-%{version}-%{release}.xml
%define FOR_XSLT_CAT for-catalog-%{dtdname}xslt-%{version}-%{release}.xml

xmlcatbin=/usr/bin/xmlcatalog
# build root catalog fragment
rm -f %{FOR_ROOT_CAT}.tmp %{FOR_XSLT_CAT}.tmp

$xmlcatbin --noout --create %{FOR_ROOT_CAT}.tmp
#CATALOG=%{xml_mod_dtd_dir}/catalog.xml
NOVCAT=%{xml_mod_dtd_dir}/catalog.xml
$xmlcatbin --noout --add "delegatePublic" "-//Novell//DTD NovDoc XML" \
    "file://$NOVCAT" %{FOR_ROOT_CAT}.tmp
$xmlcatbin --noout --add "delegateSystem" "novdocx.dtd" \
    "file://$NOVCAT" %{FOR_ROOT_CAT}.tmp
# Create tag
sed '/<catalog/a\
  <group id="%{dtdname}-%{version}-%{release}">
/<\/catalog/i\
  </group>' \
  %{FOR_ROOT_CAT}.tmp > %{FOR_ROOT_CAT}


#
$xmlcatbin --noout --create %{FOR_XSLT_CAT}.tmp
$xmlcatbin --noout --add "system" "urn:x-suse:xslt:profiling:docbook41-profile.xsl" \
  "file://%{docbuilddir}/xslt/profiling/docbook41-profile.xsl" %{FOR_XSLT_CAT}.tmp
$xmlcatbin --noout --add "system" "urn:x-suse:xslt:profiling:docbook42-profile.xsl" \
  "file://%{docbuilddir}/xslt/profiling/docbook42-profile.xsl" %{FOR_XSLT_CAT}.tmp
$xmlcatbin --noout --add "system" "urn:x-suse:xslt:profiling:docbook43-profile.xsl" \
  "file://%{docbuilddir}/xslt/profiling/docbook43-profile.xsl" %{FOR_XSLT_CAT}.tmp
$xmlcatbin --noout --add "system" "urn:x-suse:xslt:profiling:docbook44-profile.xsl" \
  "file://%{docbuilddir}/xslt/profiling/docbook44-profile.xsl" %{FOR_XSLT_CAT}.tmp
$xmlcatbin --noout --add "system" "urn:x-suse:xslt:profiling:novdoc-profile.xsl" \
  "file://%{docbuilddir}/xslt/profiling/novdoc-profile.xsl" %{FOR_XSLT_CAT}.tmp
#$xmlcatbin --noout --add "rewriteSystem" "urn:x-suse:common:" \
#  "file://$NOVCAT" %{FOR_ROOT_CAT}.tmp
sed '/<catalog/a\
  <group id="%{dtdname}xslt-%{version}-%{release}">
/<\/catalog/i\
  </group>' \
  %{FOR_XSLT_CAT}.tmp > %{FOR_XSLT_CAT}



#----------------------
%install
[ "$RPM_BUILD_ROOT" != "/" ] && [ -d $RPM_BUILD_ROOT ] && rm -rf $RPM_BUILD_ROOT;
mkdir -p $RPM_BUILD_ROOT/usr/share \
         $RPM_BUILD_ROOT/%{_bindir} \
         $RPM_BUILD_ROOT/%{xml_dir}/%{dtdname}/schema/{dtd,rng}/%{dtdversion}

tar xjf %{SOURCE0} -C $RPM_BUILD_ROOT/usr/share
mv $RPM_BUILD_ROOT/usr/share/%{name}/schema/{*.dtd,catalog.xml,CATALOG} \
   $RPM_BUILD_ROOT/%{xml_dir}/%{dtdname}/schema/dtd/%{dtdversion}
mv $RPM_BUILD_ROOT/usr/share/%{name}/schema/*.rng \
   $RPM_BUILD_ROOT/%{xml_dir}/%{dtdname}/schema/rng/%{dtdversion}

# Catalog
%{INSTALL_DIR} $RPM_BUILD_ROOT%{sgml_var_dir}
%{INSTALL_DIR} $RPM_BUILD_ROOT%{sgml_dir}
echo "CATALOG \"%{xml_mod_dtd_dir}/CATALOG\"" \
  >$RPM_BUILD_ROOT%{sgml_var_dir}/CATALOG.%{dtdname}-%{dtdversion}
ln -s %{sgml_var_dir}/CATALOG.%{dtdname}-%{dtdversion} \
  $RPM_BUILD_ROOT%{sgml_dir}/CATALOG.%{dtdname}-%{dtdversion}
cat_dir=%{buildroot}/etc/xml
%{INSTALL_DIR} $cat_dir
%{INSTALL_DATA} %{FOR_ROOT_CAT} $cat_dir
%{INSTALL_DATA} %{FOR_XSLT_CAT} $cat_dir
%define all_cat CATALOG.%{dtdname}-%{dtdversion}
%{__mv} $RPM_BUILD_ROOT/%{docbuilddir}/bin/susedoc-new.py  $RPM_BUILD_ROOT/%{_bindir} 

#----------------------
%post
if [ -x %{regcat} ]; then
  for c in  %{all_cat}; do
    %{regcat} -a %{sgml_dir}/$c >/dev/null 2>&1
  done
fi
edit-xml-catalog --group --catalog /etc/xml/suse-catalog.xml \
  --add /etc/xml/%{FOR_ROOT_CAT}
edit-xml-catalog --group --catalog /etc/xml/suse-catalog.xml \
  --add /etc/xml/%{FOR_XSLT_CAT}
exit 0

#----------------------
%postun
if [ "$1" = "0" -a -x %{regcat} ]; then
  for c in  %{all_cat}; do
    %{regcat} -r %{sgml_dir}/$c >/dev/null 2>&1
  done
fi
#now XML catalog
edit-xml-catalog --group --catalog /etc/xml/suse-catalog.xml \
  --del %{dtdname}-%{version}-%{release}
edit-xml-catalog --group --catalog /etc/xml/suse-catalog.xml \
  --del %{dtdname}xslt-%{version}-%{release}
exit 0


%clean
[ "$RPM_BUILD_ROOT" != "/" ] && [ -d $RPM_BUILD_ROOT ] && rm -rf $RPM_BUILD_ROOT;

%files
%defattr(-,root,root)
#%dir %{sgml_dir}
%if %suse_version <= 1020
#%dir %{xml_dir}
%endif
%config %{sgml_var_dir}/*
%config %{xml_sysconf_dir}/%{FOR_ROOT_CAT}
%config %{xml_sysconf_dir}/%{FOR_XSLT_CAT}
%{_bindir}/susedoc-new.py
%{sgml_dir}/CATALOG.%{dtdname}-%{dtdversion}
%{xml_dir}/%{dtdname}/
%{docbuilddir}


%changelog -n susedoc
# 